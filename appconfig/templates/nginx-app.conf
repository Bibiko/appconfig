{%- if SITE %}
  {%- if VBOX_LOCALHOST %}
#server {
#    server_name  *.{{ app.domain }};
#    server_name  *.{{ app.domain }};
#    return       301 http://{{ app.domain }}$request_uri;
#}
  {%- else %}
server {
    server_name  *.{{ app.domain }};
    return       301 http://{{ app.domain }}$request_uri;
}
server {
    listen 80;
    server_name  {{ app.domain }};
    return       301 https://{{ app.domain }}$request_uri;
}

  {%- endif %}

server {
  {%- if VBOX_LOCALHOST %}
    server_name {{ app.domain }};
    #server_name localhost;
  {%- else %}
    server_name {{ app.domain }};

    {%- if SITE %}
      listen 443 ssl;
      ssl_certificate /etc/letsencrypt/live/{{ app.domain }}/fullchain.pem;
      ssl_certificate_key /etc/letsencrypt/live/{{ app.domain }}/privkey.pem;
    {%- endif %}
  {%- endif %}
    access_log off;

    root {{ app.www_dir }};
{%- endif %}

    location {% if not SITE %}/{{ app.name }}{% endif %}/ {
{{ auth }}
            proxy_pass_header Server;
            proxy_set_header Host $http_host;
            proxy_redirect off;
            proxy_set_header X-Forwarded-For  $remote_addr;
            proxy_set_header X-Forwarded-Protocol ssl;
	    proxy_set_header X-Forwarded-Proto https;
	    proxy_set_header X-Forwarded-SSL on;
            proxy_set_header X-Scheme $scheme;
            proxy_connect_timeout 20;
            proxy_read_timeout 20;
            proxy_pass http://127.0.0.1:{{ app.port }}/;
    }

    location {% if not SITE %}/{{ app.name }}{% endif %}/admin {
{{ admin_auth }}
            proxy_pass_header Server;
            proxy_set_header Host $http_host;
            proxy_redirect off;
            proxy_set_header X-Forwarded-For  $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_connect_timeout 20;
            proxy_read_timeout 20;
            proxy_pass http://127.0.0.1:{{ app.port }}/admin;
    }

    {%- if app.stack == 'clld' %}
    location {% if not SITE %}/{{ app.name }}{% endif %}/clld-static/ {
            alias {{ clld_dir }}/web/static/;
            autoindex off;
    }
    {%- endif %}
    location {% if not SITE %}/{{ app.name }}{% endif %}/static/ {
            alias {{ app.static_dir }}/;
            charset_types text/plain;
            charset utf-8;
            autoindex off;
    }

{%- if SITE %}
    location /files/ {
            alias {{ app.www_dir }}/files/;
            autoindex off;
    }

    error_page 502 503 =502 /503.html;
    location = /503.html {
        root {{ app.www_dir }};
    }
}
{%- endif %}
